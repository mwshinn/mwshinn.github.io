<html>
  <head>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="res-tz/pikaday.min.css">
    <script src="res-tz/moment.min.js"></script>
    <script src="res-tz/moment-timezone-with-data-10-year-range.min.js"></script>
    <script src="pikaday.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>Timezone converter</h1>
    <div id="picker">
      <h2>Choose a time:</h2>
      <p>After selecting your time, you will receive a URL which
        will show this time in the user's timezone.</p>
      <form action="tz.html" method="get">
        Time: <input type="text" placeholder="HH" id="hour" name="h" size="2">
        :
        <input type="text" placeholder="00" id="hour" name="h" size="2">
        <select id="ampm" name="ampm">
          <option value="AM">AM</option>
          <option value="PM">PM</option>
        </select>
        <br />
        Date: <input placeholder="(optional)" type="text" id="date" name="d">
        <br />
        Timezone: <select class="u-full-width" id="timezone" name="tz">
          <!--Will be filled in js-->
        </select> <br />
        <input type="submit" value="Generate link">
      </form>
    </div> <!--picker-->
    <div id="displaytime" hidden="true">
          <h2>Your time <span id="localtimezone"></span>: <span id="localtime"></span></h2>
          <p>Organizer's time <span id="organizertimezone"></span>: <span id="organizertime"></span></p>
          <p><button id="showalllink">Time in other locations</button></p>
          <table id="timetable" hidden="true">
            <thead>
              <tr>
                <th>Location</th>
                <th>Time</th>
              </tr>
            </thead>
          </table>
        <p><form action="tz.html"><input type="submit" value="Choose a new time" /></p>

    </div>
    <script>
      // Global variables
      timezones = moment.tz.names();
      curr_tz = moment.tz.guess();
      // Set up the form
      var select = document.getElementById("timezone");
      for (tz of timezones) {
          var opt = document.createElement("option");
          opt.value = tz;
          // Make text pretty
          tztext = tz;
          tztext = tztext.replace(/(America|Asia|Africa)\//, "")
          opt.textContent = tztext;
          select.appendChild(opt);
      }
      select.selectedIndex = timezones.indexOf(curr_tz);
      // Parse GET parameters
      var url = new URL(window.location.href);
      var hour = url.searchParams.get("h");
      var min = url.searchParams.get("m") || "00";
      if (min.length == 1) {
          min = "0" + min;
      }
      var tz = url.searchParams.get("tz");
      var ampm = url.searchParams.get("ampm");
      var d = url.searchParams.get("d");
      var date = d || moment().format("YYYY-MM-DD");
      if (hour && tz && ampm) {
          document.getElementById("picker").hidden = true;
          document.getElementById("displaytime").hidden = false;
          var drawTable = true;
      } else {
          document.getElementById("picker").hidden = false;
          document.getElementById("displaytime").hidden = true;
          var drawTable = false;
      }
      if (drawTable) {
          // Set local and organizer time
          var eventtime = moment.tz(date + " " + hour + ":" + min + " " + ampm, "YYYY-MM-DD hh:mm A", tz);
          var display_format = d ? "MMM Do YYYY h:mm A" : "h:mm A"
          document.getElementById("organizertimezone").innerHTML = "("+eventtime.tz(tz).format('z')+")";
          document.getElementById("localtimezone").innerHTML = "("+eventtime.tz(curr_tz).format('z')+")";
          document.getElementById("organizertime").innerHTML = eventtime.tz(tz).format(display_format);
          document.getElementById("localtime").innerHTML = eventtime.tz(curr_tz).format(display_format);
          // Add timezones to the table
          var timetable = document.getElementById('timetable');
          for (tztz of timezones) {
              var row = timetable.insertRow(-1);
              row.insertCell(-1).innerHTML = tztz;
              row.insertCell(-1).innerHTML = eventtime.tz(tztz).format(display_format);
          }
      }
      // Show all
      document.getElementById("showalllink").onclick = function() {
          document.getElementById("showalllink").hidden = true;
          document.getElementById("timetable").hidden = false;
          return false;
      }
      // Calendar widget
          var picker = new Pikaday({
        field: document.getElementById('date'),
              minDate: new Date(),
              format: 'YYYY-MM-DD'
          })
    </script>
  </body>
</html>
